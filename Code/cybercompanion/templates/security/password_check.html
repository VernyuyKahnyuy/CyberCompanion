<!-- /templates/security/password_check.html -->
{% extends 'base.html' %}

{% block title %}Password Strength Check - CyberCompanion{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    
    <!-- Page Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Password Strength Check</h1>
            <p class="text-gray-600 mt-2">Test your password strength and get security recommendations</p>
        </div>
        <a href="{% url 'dashboard:home' %}" 
           class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
            Back to Dashboard
        </a>
    </div>
    
    <!-- Password Check Form -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Test Your Password</h2>
        
        <form method="post" class="space-y-4" id="password-form">
            {% csrf_token %}
            
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
                    Enter Password to Test
                </label>
                <div class="relative">
                    <input type="password" 
                           id="password" 
                           name="password" 
                           required 
                           placeholder="Enter your password"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 pr-12"
                           value="{{ request.POST.password|default:'' }}">
                    <button type="button" 
                            id="toggle-password"
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                        <span id="eye-icon">üëÅÔ∏è</span>
                    </button>
                </div>
            </div>
            
            <!-- Real-time strength indicator -->
            <div id="strength-indicator" class="hidden">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="text-sm font-medium text-gray-700">Strength:</span>
                    <div class="flex space-x-1">
                        <div class="strength-bar w-4 h-2 bg-gray-200 rounded"></div>
                        <div class="strength-bar w-4 h-2 bg-gray-200 rounded"></div>
                        <div class="strength-bar w-4 h-2 bg-gray-200 rounded"></div>
                        <div class="strength-bar w-4 h-2 bg-gray-200 rounded"></div>
                        <div class="strength-bar w-4 h-2 bg-gray-200 rounded"></div>
                    </div>
                    <span id="strength-text" class="text-sm font-medium"></span>
                </div>
                <div id="live-feedback" class="text-sm text-gray-600"></div>
            </div>
            
            <div class="flex items-center space-x-4">
                <button type="submit" 
                        class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors">
                    Analyze Password
                </button>
                
                <button type="button" 
                        id="generate-password"
                        class="px-6 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors">
                    Generate Strong Password
                </button>
            </div>
            
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                <div class="flex">
                    <div class="text-yellow-400 text-lg mr-3">‚ö†Ô∏è</div>
                    <div>
                        <h3 class="text-sm font-medium text-yellow-800">Privacy Notice:</h3>
                        <p class="text-sm text-yellow-700 mt-1">
                            Your passwords are never stored or transmitted. All analysis happens locally in your browser 
                            for maximum security and privacy.
                        </p>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Results Section -->
    {% if password_check %}
    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Password Analysis Results</h2>
        
        <!-- Overall Score Display -->
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-xl font-bold text-gray-800">Overall Score</h3>
                    <p class="text-gray-600">Based on multiple security factors</p>
                </div>
                <div class="text-right">
                    <div class="text-4xl font-bold {{ password_check.color_class }}">
                        {{ password_check.strength_score }}/100
                    </div>
                    <div class="text-sm font-medium {{ password_check.color_class }}">
                        {{ password_check.strength_label }}
                    </div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="mt-4">
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div class="h-3 rounded-full transition-all duration-500 {% if password_check.strength_score >= 70 %}bg-green-500{% elif password_check.strength_score >= 50 %}bg-yellow-500{% else %}bg-red-500{% endif %}" 
                         data-width="{{ password_check.strength_score }}"
                         id="progress-bar"></div>
                </div>
            </div>
        </div>
        
        <!-- Character Analysis -->
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
            <h4 class="font-bold text-gray-800 mb-3">Password Composition</h4>
            <div class="grid md:grid-cols-2 gap-4">
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Length:</span>
                        <span class="font-medium">{{ password_check.length }} characters</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Uppercase Letters:</span>
                        <span class="{% if password_check.has_uppercase %}text-green-600{% else %}text-red-600{% endif %}">
                            {% if password_check.has_uppercase %}‚úì Yes{% else %}‚úó No{% endif %}
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Lowercase Letters:</span>
                        <span class="{% if password_check.has_lowercase %}text-green-600{% else %}text-red-600{% endif %}">
                            {% if password_check.has_lowercase %}‚úì Yes{% else %}‚úó No{% endif %}
                        </span>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Numbers:</span>
                        <span class="{% if password_check.has_numbers %}text-green-600{% else %}text-red-600{% endif %}">
                            {% if password_check.has_numbers %}‚úì Yes{% else %}‚úó No{% endif %}
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Symbols:</span>
                        <span class="{% if password_check.has_symbols %}text-green-600{% else %}text-red-600{% endif %}">
                            {% if password_check.has_symbols %}‚úì Yes{% else %}‚úó No{% endif %}
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Unique Password:</span>
                        <span class="{% if password_check.is_unique %}text-green-600{% else %}text-orange-600{% endif %}">
                            {% if password_check.is_unique %}‚úì Unique{% else %}‚ö† Reused{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Basic Recommendations -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h4 class="font-bold text-blue-800 mb-3 flex items-center">
                <span class="mr-2">üí°</span> Recommendations
            </h4>
            <ul class="text-blue-700 text-sm space-y-2">
                {% if password_check.strength_score < 70 %}
                    {% if password_check.length < 12 %}
                    <li class="flex items-start">
                        <span class="text-blue-500 mr-2 mt-1">‚Ä¢</span>
                        Use at least 12 characters for better security
                    </li>
                    {% endif %}
                    
                    {% if not password_check.has_uppercase %}
                    <li class="flex items-start">
                        <span class="text-blue-500 mr-2 mt-1">‚Ä¢</span>
                        Add uppercase letters (A-Z)
                    </li>
                    {% endif %}
                    
                    {% if not password_check.has_lowercase %}
                    <li class="flex items-start">
                        <span class="text-blue-500 mr-2 mt-1">‚Ä¢</span>
                        Add lowercase letters (a-z)
                    </li>
                    {% endif %}
                    
                    {% if not password_check.has_numbers %}
                    <li class="flex items-start">
                        <span class="text-blue-500 mr-2 mt-1">‚Ä¢</span>
                        Add numbers (0-9)
                    </li>
                    {% endif %}
                    
                    {% if not password_check.has_symbols %}
                    <li class="flex items-start">
                        <span class="text-blue-500 mr-2 mt-1">‚Ä¢</span>
                        Add special characters (!@#$%^&*)
                    </li>
                    {% endif %}
                    
                    <li class="flex items-start">
                        <span class="text-blue-500 mr-2 mt-1">‚Ä¢</span>
                        Consider using a password manager
                    </li>
                    
                    <li class="flex items-start">
                        <span class="text-blue-500 mr-2 mt-1">‚Ä¢</span>
                        Use unique passwords for each account
                    </li>
                {% else %}
                    <li class="text-blue-700">Great job! Your password follows security best practices.</li>
                    <li class="flex items-start">
                        <span class="text-blue-500 mr-2 mt-1">‚Ä¢</span>
                        Remember to use unique passwords for each account
                    </li>
                    <li class="flex items-start">
                        <span class="text-blue-500 mr-2 mt-1">‚Ä¢</span>
                        Consider enabling two-factor authentication
                    </li>
                {% endif %}
            </ul>
        </div>
    </div>
    {% endif %}
    
    <!-- Password Generation Section -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Password Generator</h2>
        
        <div class="space-y-4">
            <!-- Generated Password Display -->
            <div id="generated-password-section" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Generated Password</label>
                <div class="flex space-x-2">
                    <input type="text" 
                           id="generated-password" 
                           readonly 
                           class="flex-1 px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg font-mono text-sm">
                    <button type="button" 
                            id="copy-password"
                            class="px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        Copy
                    </button>
                </div>
            </div>
            
            <!-- Generation Options -->
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password Length</label>
                    <input type="range" 
                           id="password-length" 
                           min="8" 
                           max="32" 
                           value="16" 
                           class="w-full">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>8</span>
                        <span id="length-display">16</span>
                        <span>32</span>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Include Characters</label>
                    <div class="space-y-1">
                        <label class="flex items-center">
                            <input type="checkbox" id="include-uppercase" checked class="mr-2">
                            <span class="text-sm">Uppercase (A-Z)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="include-lowercase" checked class="mr-2">
                            <span class="text-sm">Lowercase (a-z)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="include-numbers" checked class="mr-2">
                            <span class="text-sm">Numbers (0-9)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="include-symbols" checked class="mr-2">
                            <span class="text-sm">Symbols (!@#$%^&*)</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Previous Checks History -->
    {% if previous_checks %}
    <div class="bg-white rounded-xl shadow-sm p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Previous Password Checks</h2>
        
        <div class="space-y-3">
            {% for check in previous_checks %}
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3 
                                {% if check.strength_score >= 70 %}bg-green-100 text-green-600
                                {% elif check.strength_score >= 50 %}bg-yellow-100 text-yellow-600
                                {% else %}bg-red-100 text-red-600{% endif %}">
                        {% if check.strength_score >= 70 %}üõ°Ô∏è
                        {% elif check.strength_score >= 50 %}‚ö†Ô∏è
                        {% else %}‚ùå{% endif %}
                    </div>
                    <div>
                        <div class="font-medium text-gray-800">Password Check</div>
                        <div class="text-sm text-gray-600">
                            Score: {{ check.strength_score }}/100 ({{ check.strength_label }})
                        </div>
                    </div>
                </div>
                <div class="text-sm text-gray-500">
                    {{ check.created_at|timesince }} ago
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
</div>

<!-- JavaScript for interactive features -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Password visibility toggle
    const togglePassword = document.getElementById('toggle-password');
    const passwordInput = document.getElementById('password');
    const eyeIcon = document.getElementById('eye-icon');
    
    togglePassword.addEventListener('click', function() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        eyeIcon.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
    });
    
    // Real-time password strength checking
    const strengthIndicator = document.getElementById('strength-indicator');
    const strengthBars = document.querySelectorAll('.strength-bar');
    const strengthText = document.getElementById('strength-text');
    const liveFeedback = document.getElementById('live-feedback');
    
    passwordInput.addEventListener('input', function() {
        const password = this.value;
        if (password.length > 0) {
            strengthIndicator.classList.remove('hidden');
            const analysis = analyzePasswordStrength(password);
            updateStrengthDisplay(analysis);
        } else {
            strengthIndicator.classList.add('hidden');
        }
    });
    
    // Password generator
    const generateBtn = document.getElementById('generate-password');
    const generatedPasswordSection = document.getElementById('generated-password-section');
    const generatedPasswordInput = document.getElementById('generated-password');
    const copyBtn = document.getElementById('copy-password');
    const lengthSlider = document.getElementById('password-length');
    const lengthDisplay = document.getElementById('length-display');
    
    lengthSlider.addEventListener('input', function() {
        lengthDisplay.textContent = this.value;
    });
    
    generateBtn.addEventListener('click', function() {
        const length = parseInt(lengthSlider.value);
        const includeUpper = document.getElementById('include-uppercase').checked;
        const includeLower = document.getElementById('include-lowercase').checked;
        const includeNumbers = document.getElementById('include-numbers').checked;
        const includeSymbols = document.getElementById('include-symbols').checked;
        
        const password = generateSecurePassword(length, includeUpper, includeLower, includeNumbers, includeSymbols);
        generatedPasswordInput.value = password;
        generatedPasswordSection.classList.remove('hidden');
    });
    
    copyBtn.addEventListener('click', function() {
        generatedPasswordInput.select();
        document.execCommand('copy');
        this.textContent = 'Copied!';
        this.classList.add('bg-green-700');
        setTimeout(() => {
            this.textContent = 'Copy';
            this.classList.remove('bg-green-700');
        }, 2000);
    });
    
    // Helper functions
    function analyzePasswordStrength(password) {
        let score = 0;
        let feedback = [];
        
        // Length check
        if (password.length >= 12) {
            score += 25;
        } else if (password.length >= 8) {
            score += 15;
            feedback.push('Consider using 12+ characters');
        } else {
            feedback.push('Too short - use at least 8 characters');
        }
        
        // Character variety
        if (/[a-z]/.test(password)) score += 15;
        if (/[A-Z]/.test(password)) score += 15;
        if (/[0-9]/.test(password)) score += 15;
        if (/[^A-Za-z0-9]/.test(password)) score += 20;
        
        // Patterns and common issues
        if (!/(.)\1{2,}/.test(password)) score += 10; // No repeated characters
        
        let level = 'weak';
        if (score >= 80) level = 'very strong';
        else if (score >= 60) level = 'strong';
        else if (score >= 40) level = 'moderate';
        
        return { score, level, feedback };
    }
    
    function updateStrengthDisplay(analysis) {
        const { score, level, feedback } = analysis;
        
        // Update bars
        const filledBars = Math.ceil(score / 20);
        strengthBars.forEach((bar, index) => {
            bar.className = 'strength-bar w-4 h-2 rounded';
            if (index < filledBars) {
                if (score >= 80) bar.classList.add('bg-green-500');
                else if (score >= 60) bar.classList.add('bg-yellow-500');
                else if (score >= 40) bar.classList.add('bg-orange-500');
                else bar.classList.add('bg-red-500');
            } else {
                bar.classList.add('bg-gray-200');
            }
        });
        
        // Update text
        strengthText.textContent = level.charAt(0).toUpperCase() + level.slice(1);
        strengthText.className = `text-sm font-medium ${
            score >= 80 ? 'text-green-600' :
            score >= 60 ? 'text-yellow-600' :
            score >= 40 ? 'text-orange-600' : 'text-red-600'
        }`;
        
        liveFeedback.textContent = feedback.join(' ‚Ä¢ ');
    }
    
    function generateSecurePassword(length, upper, lower, numbers, symbols) {
        let charset = '';
        if (upper) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        if (lower) charset += 'abcdefghijklmnopqrstuvwxyz';
        if (numbers) charset += '0123456789';
        if (symbols) charset += '!@#$%^&*()_+-=[]{}|;:,.<>?';
        
        if (!charset) charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        
        let password = '';
        for (let i = 0; i < length; i++) {
            password += charset.charAt(Math.floor(Math.random() * charset.length));
        }
        return password;
    }
});
</script>
{% endblock %}