{% extends 'base.html' %}

{% block title %}Dashboard - CyberCompanion{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    {% csrf_token %}
    
    <!-- Pet Display Section -->
    <div class="pet-container p-8 mb-8 text-center relative overflow-hidden">
        <!-- Background decorative elements -->
        <div class="absolute inset-0 opacity-10">
            <div class="absolute top-4 left-8 w-16 h-16 bg-green-300 rounded-full"></div>
            <div class="absolute bottom-6 right-12 w-12 h-12 bg-blue-300 rounded-full"></div>
            <div class="absolute top-1/2 right-8 w-8 h-8 bg-purple-300 rounded-full"></div>
        </div>
        
        <div class="relative z-10">
            <!-- Pet Image -->
            <div class="pet-animation mb-6">
                <div class="w-32 h-32 mx-auto mb-4 relative">
                    <!-- Pet Avatar (placeholder - you can replace with actual pet images) -->
                    <div class="w-full h-full bg-gradient-to-br from-green-400 to-blue-500 rounded-full flex items-center justify-center shadow-lg">
                        <div class="text-4xl">
                            {% if user.cyber_pet.current_mood == 'happy' %}
                                üòä
                            {% elif user.cyber_pet.current_mood == 'excited' %}
                                üéâ
                            {% elif user.cyber_pet.current_mood == 'worried' %}
                                üòü
                            {% elif user.cyber_pet.current_mood == 'sad' %}
                                üò¢
                            {% else %}
                                üòê
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Mood Badge -->
                    <div class="absolute -top-2 -right-2 px-2 py-1 bg-green-500 text-white text-xs font-bold rounded-full">
                        {{ user.cyber_pet.get_current_mood_display|title }}
                    </div>
                </div>
            </div>
            
            <!-- Pet Status -->
            <h2 class="text-2xl font-bold text-gray-800 mb-2">
                Your Cyber Pet is {{ user.cyber_pet.get_current_mood_display|title }}!
            </h2>
            <p class="text-gray-600 italic text-lg" 
               hx-get="{% url 'pet:mood_message' %}" 
               hx-trigger="every 30s"
               hx-swap="innerHTML"
               hx-target = "this"
               hx-swap-oob = "true"
               hx-on="htmx:afterRequnest: this.innerHTML = JSON.parse(this.responseText).message">

               {{mood_message}}
                <!-- "{{ user.cyber_pet.get_mood_message }}" -->
            </p>
        </div>
    </div>
    
    <!-- Stats and Activity Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Security Stats Column -->
        <div class="lg:col-span-2">
            <h3 class="text-xl font-bold text-gray-800 mb-6">Security Stats</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                
                <!-- Password Strength Card -->
                <div class="stat-card p-6">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-semibold text-gray-700">Password Strength</h4>
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    </div>
                    <div class="text-2xl font-bold text-gray-800 mb-1">
                        {% if latest_password_check %}
                            {{ latest_password_check.strength_label }}
                        {% else %}
                            Not Checked
                        {% endif %}
                    </div>
                    <p class="text-sm text-gray-500">
                        Last check: 
                        {% if latest_password_check %}
                            {{ latest_password_check.created_at|timesince }} ago
                        {% else %}
                            Never
                        {% endif %}
                    </p>
                </div>
                
                <!-- Breach Check Card -->
                <div class="stat-card p-6">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-semibold text-gray-700">Breach Check</h4>
                        <div class="w-3 h-3 {% if latest_breach_check.breaches_found == 0 %}bg-green-500{% else %}bg-red-500{% endif %} rounded-full"></div>
                    </div>
                    <div class="text-2xl font-bold text-gray-800 mb-1">
                        {% if latest_breach_check %}
                            {% if latest_breach_check.breaches_found == 0 %}
                                Clean
                            {% else %}
                                {{ latest_breach_check.breaches_found }} Found
                            {% endif %}
                        {% else %}
                            Not Checked
                        {% endif %}
                    </div>
                    <p class="text-sm text-gray-500">
                        Last scan: 
                        {% if latest_breach_check %}
                            {{ latest_breach_check.last_checked|timesince }} ago
                        {% else %}
                            Never
                        {% endif %}
                    </p>
                </div>
                
                <!-- Weekly Score Card -->
                <div class="stat-card p-6">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-semibold text-gray-700">Weekly Score</h4>
                        <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                    </div>
                    <div class="text-2xl font-bold text-gray-800 mb-1">
                        {{ user.profile.get_overall_security_grade }}
                    </div>
                    <p class="text-sm text-gray-500">Good actions this week</p>
                </div>
                
            </div>
            
            <!-- Quick Actions -->
            <h3 class="text-xl font-bold text-gray-800 mb-6">Quick Actions</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <!-- Email Breach Check -->
                <a href="{% url 'security:breach_check' %}" 
                   class="quick-action-btn bg-blue-100 border-2 border-blue-200 hover:border-blue-300">
                    <div class="text-blue-600 text-3xl mb-3">üîç</div>
                    <h4 class="font-semibold text-blue-800 mb-2">Check Email Breach</h4>
                    <p class="text-sm text-blue-600">Scan your email for data breaches</p>
                </a>
                
                <!-- Password Check -->
                <a href="{% url 'security:password_check' %}" 
                   class="quick-action-btn bg-green-100 border-2 border-green-200 hover:border-green-300">
                    <div class="text-green-600 text-3xl mb-3">üîí</div>
                    <h4 class="font-semibold text-green-800 mb-2">Run Password Check</h4>
                    <p class="text-sm text-green-600">Test your password strength</p>
                </a>
                
                <!-- Security Tips -->
                <a href="{% url 'dashboard:security_tips' %}" 
                   class="quick-action-btn bg-orange-100 border-2 border-orange-200 hover:border-orange-300">
                    <div class="text-orange-600 text-3xl mb-3">üí°</div>
                    <h4 class="font-semibold text-orange-800 mb-2">View Security Tips</h4>
                    <p class="text-sm text-orange-600">Learn to stay safe online</p>
                </a>
                
            </div>
        </div>
        
        <!-- Recent Activity Column -->
        <div class="lg:col-span-1">
            <h3 class="text-xl font-bold text-gray-800 mb-6">Recent Activity</h3>
            
            <div class="space-y-3" 
                 hx-get="{% url 'dashboard:recent_activity' %}" 
                 hx-trigger="every 60s"
                 hx-swap="innerHTML">
                
                {% for action in recent_actions %}
                <div class="activity-item {% if action.is_positive_action %}activity-positive{% elif action.action_type == 'password_check_weak' or 'breach_found' in action.action_type %}activity-warning{% else %}activity-info{% endif %}">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-3
                                    {% if action.is_positive_action %}bg-green-500{% elif action.action_type == 'password_check_weak' or 'breach_found' in action.action_type %}bg-orange-500{% else %}bg-blue-500{% endif %}">
                            <div class="text-white text-sm">
                                {% if action.is_positive_action %}
                                    ‚úì
                                {% elif action.action_type == 'password_check_weak' or 'breach_found' in action.action_type %}
                                    ‚ö†
                                {% else %}
                                    ‚Ñπ
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-800">
                                {% if action.action_type == 'password_check_strong' %}
                                    You enabled 2FA on Gmail
                                {% elif action.action_type == 'suspicious_link_detected' %}
                                    Suspicious link detected
                                {% elif action.action_type == 'password_updated' %}
                                    Updated strong password
                                {% elif action.action_type == 'security_scan_completed' %}
                                    Completed security training
                                {% else %}
                                    {{ action.get_action_type_display }}
                                {% endif %}
                            </p>
                            <p class="text-xs text-gray-500">
                                {{ action.created_at|timesince }} ago
                            </p>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="activity-item activity-info">
                    <div class="text-center py-4">
                        <p class="text-gray-500 text-sm">No recent activity</p>
                        <p class="text-gray-400 text-xs">Start securing your accounts to see activities here!</p>
                    </div>
                </div>
                {% endfor %}
                
            </div>
        </div>
        
    </div>
</div>

<!-- Auto-refresh pet mood -->
<script>
    // Update pet mood every 5 minutes
    setInterval(function() {
        htmx.ajax('GET', '{% url "pet:update_mood" %}', {
            target: '.pet-container',
            swap: 'outerHTML'
        });
    }, 300000); // 5 minutes
</script>

{% endblock %}

{% block extra_css %}
<style>
    /* Additional animations for dashboard */
    .stat-card {
        animation: fadeInUp 0.6s ease-out;
    }
    
    .stat-card:nth-child(2) {
        animation-delay: 0.1s;
    }
    
    .stat-card:nth-child(3) {
        animation-delay: 0.2s;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .quick-action-btn {
        animation: fadeInUp 0.6s ease-out;
        animation-fill-mode: both;
    }
    
    .quick-action-btn:nth-child(1) {
        animation-delay: 0.3s;
    }
    
    .quick-action-btn:nth-child(2) {
        animation-delay: 0.4s;
    }
    
    .quick-action-btn:nth-child(3) {
        animation-delay: 0.5s;
    }
</style>
{% endblock %}